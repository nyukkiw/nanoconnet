import{s as e,i as r,a as t}from"./index-gdKssIVa.js";const a={async createBooking(r){try{const{data:t,error:a}=await e.from("bookings").insert([{sme_id:r.smeId,influencer_id:r.influencerId,campaign_name:r.campaignName,budget:r.budget,num_posts:r.numPosts,start_date:r.startDate,end_date:r.endDate,description:r.description,status:"pending"}]).select();if(a)throw a;return{data:null==t?void 0:t[0],error:null}}catch(t){return{data:null,error:t.message}}},async getUserBookings(r,t="sme"){try{const a="sme"===t?"sme_id":"influencer_id",{data:n,error:s}=await e.from("bookings").select(`\n          id,\n          campaign_name,\n          budget,\n          num_posts,\n          start_date,\n          end_date,\n          description,\n          status,\n          created_at,\n          ${"sme"===t?"influencers (id, niche, price_per_post, users(name, profile_image_url))":"smes (id, name, users(profile_image_url))"}\n        `).eq(a,r).order("created_at",{ascending:!1});if(s)throw s;return{data:n,error:null}}catch(a){return{data:null,error:a.message}}},async getBookingById(r){try{const{data:t,error:a}=await e.from("bookings").select("\n          id,\n          campaign_name,\n          budget,\n          num_posts,\n          start_date,\n          end_date,\n          description,\n          status,\n          created_at,\n          smes (id, name, users(name, profile_image_url, email)),\n          influencers (id, niche, price_per_post, users(name, profile_image_url, email))\n        ").eq("id",r).single();if(a)throw a;return{data:t,error:null}}catch(t){return{data:null,error:t.message}}},async updateBookingStatus(r,t){try{const{data:a,error:n}=await e.from("bookings").update({status:t,updated_at:new Date}).eq("id",r).select();if(n)throw n;return{data:null==a?void 0:a[0],error:null}}catch(a){return{data:null,error:a.message}}},async cancelBooking(r,t=""){try{const{data:a,error:n}=await e.from("bookings").update({status:"cancelled",cancellation_reason:t,updated_at:new Date}).eq("id",r).select();if(n)throw n;return{data:null==a?void 0:a[0],error:null}}catch(a){return{data:null,error:a.message}}}},n={async calculateMatchScore(r,t){var a;try{const{data:n,error:s}=await e.from("smes").select("budget, niche, target_audience, location").eq("id",r).single();if(s)throw s;const{data:o,error:i}=await e.from("influencers").select("price_per_post, niche, engagement_rate, rating, users(location)").eq("id",t).single();if(i)throw i;let c=0;const l={},u=40*Math.min(n.budget/o.price_per_post,1);c+=u,l.budget=u;const d=n.niche.toLowerCase()===o.niche.toLowerCase()?35:20;c+=d,l.niche=d;const m=15*Math.min(o.engagement_rate/10,1);c+=m,l.engagement=m;const g=n.location===(null==(a=o.users)?void 0:a.location)?10:5;return c+=g,l.location=g,{matchScore:Math.round(Math.min(c,100)),factors:l,error:null}}catch(n){return{matchScore:0,factors:{},error:n.message}}},async getRecommendations(r,t=5){try{const{data:a,error:n}=await e.from("smes").select("budget, niche, location").eq("id",r).single();if(n)throw n;const{data:s,error:o}=await e.from("influencers").select("\n          id,\n          niche,\n          price_per_post,\n          engagement_rate,\n          rating,\n          users(id, name, profile_image_url, location)\n        ").eq("niche",a.niche).order("rating",{ascending:!1}).limit(2*t);if(o)throw o;return{recommendations:(await Promise.all(s.map(async e=>{const{matchScore:t}=await this.calculateMatchScore(r,e.id);return{...e,matchScore:t}}))).sort((e,r)=>r.matchScore-e.matchScore).slice(0,t),error:null}}catch(a){return{recommendations:[],error:a.message}}},async saveMatchScore(r,t,a){try{const{error:n}=await e.from("matches").insert([{sme_id:r,influencer_id:t,score:a,calculated_at:new Date}]);if(n)throw n;return{error:null}}catch(n){return{error:n.message}}}},s={async getUserProfile(r){try{const{data:t,error:a}=await e.from("users").select("*").eq("id",r).single();if(a)throw a;return{data:t,error:null}}catch(t){return{data:null,error:t.message}}},async getInfluencerProfile(r){try{const{data:t,error:a}=await e.from("influencers").select("\n          *,\n          users(*)\n        ").eq("user_id",r).single();if(a)throw a;return{data:t,error:null}}catch(t){return{data:null,error:t.message}}},async getSMEProfile(r){try{const{data:t,error:a}=await e.from("smes").select("\n          *,\n          users(*)\n        ").eq("user_id",r).single();if(a)throw a;return{data:t,error:null}}catch(t){return{data:null,error:t.message}}},async updateUserProfile(r,t){try{const{data:a,error:n}=await e.from("users").update(t).eq("id",r).select();if(n)throw n;return{data:null==a?void 0:a[0],error:null}}catch(a){return{data:null,error:a.message}}},async updateInfluencerProfile(r,t){try{const{data:a,error:n}=await e.from("influencers").update(t).eq("user_id",r).select();if(n)throw n;return{data:null==a?void 0:a[0],error:null}}catch(a){return{data:null,error:a.message}}},async uploadProfileImage(r,t){try{const a=`${r}-profile.${t.name.split(".").pop()}`,{data:n,error:s}=await e.storage.from("profile-images").upload(a,t,{upsert:!0});if(s)throw s;const{data:{publicUrl:o}}=e.storage.from("profile-images").getPublicUrl(a);return await this.updateUserProfile(r,{profile_image_url:o}),{publicUrl:o,error:null}}catch(a){return{publicUrl:null,error:a.message}}}},o={auth:t,influencer:r,booking:a,matching:n,user:s};export{o as api,t as authService,a as bookingService,o as default,r as influencerService,n as matchingService,e as supabase,s as userService};
